<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Track Music Player</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Tone.js for music synthesis -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* Custom styles for aesthetic enhancements */
        body { font-family: 'Inter', sans-serif; background-color: #1a1a2e; color: #ffffff; }
        .card { background-color: #2c2a52; border: 1px solid #4a488e; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: transform 0.1s ease; }
        .card:hover { transform: translateY(-2px); }
        .btn-primary { background-color: #ff6b6b; border: 1px solid #ee5253; transition: background-color 0.1s; }
        .btn-primary:hover { background-color: #ff9b9b; }
        .btn-secondary { background-color: #48c4a4; border: 1px solid #3c9c84; }
        .btn-secondary:hover { background-color: #6ee6c7; }
        .btn-danger { background-color: #e55039; border: 1px solid #cc4030; }
        .btn-danger:hover { background-color: #ff6f5b; }
        .input-style { background-color: #3e3d64; border-color: #5d5c8d; color: #ffffff; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #ff6b6b; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Style for the "Experimental" tag */
        .experimental-tag { background-color: #5D5FEF; color: white; padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; margin-left: 8px; }
        /* Style for the track notation area */
        .notation-area { height: 100px; resize: none; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <header class="text-center mb-10">
        <h1 class="text-4xl md:text-5xl font-extrabold text-[#ff6b6b]">Tone.js Composer</h1>
        <p class="text-lg text-gray-300 mt-2">Create and save your multi-track musical ideas (SQLite Server).</p>
    </header>

    <!-- Controls & Actions -->
    <div class="flex flex-wrap gap-4 mb-8 justify-center">
        <button id="start-btn" onclick="Tone.start(); startTransport();"
                class="btn-primary px-8 py-3 rounded-xl font-bold text-lg hover:shadow-lg disabled:opacity-50" disabled>
            <span id="start-text">Loading Instruments...</span>
            <span id="loader-icon" class="loader inline-block ml-2"></span>
        </button>

        <button id="stop-btn" onclick="stopTransport()"
                class="btn-danger px-8 py-3 rounded-xl font-bold text-lg hover:shadow-lg" disabled>
            Stop
        </button>

        <select id="add-instrument" onchange="addTrack(this.value); this.value=''"
                class="input-style px-6 py-3 rounded-xl font-bold text-lg appearance-none cursor-pointer">
            <option value="" disabled selected>+ Add Track</option>
            <option value="Piano">Piano (Sampled)</option>
            <option value="Drums">Drums (Sampled)</option>
            <option value="Gong">Gong (Sampled)</option>
            <option value="Synth">Synth (Experimental)</option>
            <option value="Violin">Violin (Experimental)</option>
            <option value="Cello">Cello (Experimental)</option>
            <option value="Flute">Flute (Experimental)</option>
            <option value="Organ">Organ (Sampled)</option>
        </select>
    </div>

    <!-- Save/Load Section -->
    <div class="card p-6 rounded-xl mb-8 max-w-2xl mx-auto">
        <h2 class="text-2xl font-semibold mb-4 text-[#48c4a4]">Save & Load Tracks (via Node.js API)</h2>
        <div id="save-load-controls" class="flex flex-col sm:flex-row gap-4">
            <input type="text" id="composition-name" placeholder="Name your composition (e.g., 'My Groovy Beat')"
                   class="input-style flex-grow p-3 rounded-lg">
            <button id="save-btn" onclick="saveComposition()"
                    class="btn-secondary px-6 py-3 rounded-lg font-semibold">
                Save Composition
            </button>
            <button id="load-btn" onclick="loadCompositions()"
                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold">
                Load List
            </button>
        </div>
        <div id="load-list-container" class="mt-4 hidden max-h-40 overflow-y-auto">
            <!-- Compositions will be listed here -->
            <p class="text-gray-400">Press 'Load List' to fetch saved compositions from the server.</p>
        </div>
    </div>

    <!-- Tracks Container -->
    <div id="tracks-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Track cards will be dynamically inserted here -->
    </div>

    <!-- Application Logic -->
    <script type="module">
        // ----------------------------------------------------------------------
        // 1. DATA PERSISTENCE (Node.js API Integration)
        // ----------------------------------------------------------------------
        const API_BASE_URL = 'http://localhost:3001/api/compositions';

        /**
         * Gathers all track data from the UI and sends it to the Node.js server
         * via a POST request to be saved in the SQLite database.
         */
        window.saveComposition = async () => {
            const nameInput = document.getElementById('composition-name');
            const name = nameInput.value.trim();

            if (!name) {
                // In a real app, use a modal, but for now, use console warning
                console.warn('Please enter a name for your composition.');
                return;
            }

            // 1. Gather all track data from the global array and input fields
            const tracksData = window.tracks.map(track => ({
                id: track.id, 
                instrumentType: track.instrumentType,
                instrumentName: track.instrumentName,
                // Read current values from the UI elements
                notation: document.getElementById(`notation-${track.id}`).value,
                volume: document.getElementById(`volume-${track.id}`).value,
            }));

            const dataToSave = {
                name: name,
                // Convert the complex array of tracks into a single JSON string 
                // for storage in the SQLite TEXT column.
                tracks: JSON.stringify(tracksData), 
            };

            const saveButton = document.getElementById('save-btn');
            const originalText = saveButton.textContent;
            saveButton.textContent = 'Saving...';
            saveButton.disabled = true;

            try {
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSave)
                });

                const result = await response.json();

                if (response.ok) {
                    nameInput.value = '';
                    console.log(`Composition "${name}" saved successfully! Server ID: ${result.id}`);
                } else {
                    throw new Error(result.error || 'Unknown server error.');
                }
            } catch (e) {
                console.error("Error saving composition: ", e);
                console.warn("Failed to save composition. Check console for details.");
            } finally {
                saveButton.textContent = originalText;
                saveButton.disabled = false;
                loadCompositions(); // Refresh the load list after saving
            }
        };

        /**
         * Fetches a list of saved compositions from the server and populates the load list.
         */
        window.loadCompositions = async () => {
            const listContainer = document.getElementById('load-list-container');
            listContainer.classList.remove('hidden');
            listContainer.innerHTML = '<p class="text-gray-400">Fetching compositions...</p>';

            try {
                const response = await fetch(API_BASE_URL);
                const compositions = await response.json();

                if (compositions.length === 0) {
                    listContainer.innerHTML = '<p class="text-gray-400">No saved compositions found on server.</p>';
                    return;
                }

                listContainer.innerHTML = '';
                compositions.forEach((data) => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2 my-1 rounded-lg bg-[#3e3d64] hover:bg-[#4a488e] transition';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = `${data.name} (ID: ${data.id})`;
                    nameSpan.className = 'truncate pr-2';
                    item.appendChild(nameSpan);

                    const actionDiv = document.createElement('div');
                    actionDiv.className = 'flex gap-2';
                    
                    const loadBtn = document.createElement('button');
                    loadBtn.textContent = 'Load';
                    loadBtn.className = 'text-sm bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded';
                    loadBtn.onclick = () => loadCompositionById(data.id);
                    actionDiv.appendChild(loadBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'text-sm bg-red-500 hover:bg-red-600 px-3 py-1 rounded';
                    deleteBtn.onclick = () => deleteComposition(data.id, data.name);
                    actionDiv.appendChild(deleteBtn);

                    item.appendChild(actionDiv);
                    listContainer.appendChild(item);
                });

            } catch (e) {
                console.error("Error loading compositions: ", e);
                listContainer.innerHTML = '<p class="text-red-400">Failed to connect to server API. Is Node.js server running?</p>';
            }
        };

        /**
         * Fetches the full track data for a single composition by ID from the server.
         */
        async function loadCompositionById(compositionId) {
            try {
                const response = await fetch(`${API_BASE_URL}/${compositionId}`);
                const data = await response.json();
                
                if (response.ok) {
                    loadTrackData(data.tracks);
                    document.getElementById('composition-name').value = data.name; // Set the name input
                    console.log(`Composition ID ${compositionId} loaded.`);
                } else {
                    throw new Error(data.error || 'Failed to fetch composition details.');
                }
            } catch (e) {
                console.error("Error loading track data:", e);
                console.warn("Failed to load composition.");
            }
        }

        /**
         * Sends a DELETE request to the server to remove a composition.
         */
        async function deleteComposition(compositionId, name) {
            // NOTE: Using window.confirm() for simplicity, but a custom modal is preferred
            if (window.confirm(`Are you sure you want to delete "${name}" (ID: ${compositionId})?`)) {
                try {
                    const response = await fetch(`${API_BASE_URL}/${compositionId}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();

                    if (response.ok) {
                        console.log(result.message);
                        loadCompositions(); // Refresh the list
                    } else {
                        throw new Error(result.error || 'Failed to delete on server.');
                    }
                } catch (e) {
                    console.error("Error deleting composition: ", e);
                    console.warn("Failed to delete composition.");
                }
            }
        }

        /**
         * Clears the current tracks and rebuilds them based on loaded JSON data.
         */
        function loadTrackData(tracksJson) {
            try {
                const tracksData = JSON.parse(tracksJson);
                
                // 1. Clear existing tracks
                window.tracks.forEach(track => removeTrack(track.id, false));
                window.tracks = [];
                document.getElementById('tracks-container').innerHTML = '';
                
                // 2. Load new tracks
                tracksData.forEach(data => {
                    // Re-add track using saved properties
                    window.addTrack(data.instrumentType, data.notation, data.volume);
                });

                console.log("Composition loaded successfully!");
            } catch (e) {
                console.error("Error parsing or loading tracks data: ", e);
                console.warn("Failed to load track data. Data format error.");
            }
        }


        // ----------------------------------------------------------------------
        // 2. TONE.JS INSTRUMENT LOGIC (FIXED LOADING)
        // ----------------------------------------------------------------------

        let initialized = false;
        let samplerLoadedCount = 0;
        // Total number of sampler assets we expect to preload (4 Samplers = 4 completion events)
        const totalSamplers = 4; 

        window.tracks = []; // Global array to hold track objects {id, instrument, part, instrumentType, instrumentName}

        const instrumentSettings = {
            'Piano': { type: 'Sampler', samples: { 'A1': 'A1.mp3', 'A2': 'A2.mp3', 'B1': 'B1.mp3' }, baseUrl: "https://tonejs.github.io/audio/salamander/", defaultNotation: "C4, 8n, 0; E4, 8n, +4n; G4, 8n, +4n; C5, 8n, +4n", instrumentName: "Piano (Sampled)" },
            'Drums': { type: 'Sampler', samples: { "C1": "kick.mp3", "D1": "snare.mp3", "E1": "hihat.mp3" }, baseUrl: "https://tonejs.github.io/audio/drum-samples/acoustic-kit/", defaultNotation: "C1, 4n, 0; D1, 4n, +4n; E1, 4n, +2n", instrumentName: "Drums (Sampled)" },
            'Gong': { type: 'Sampler', samples: { "C2": "C2.mp3" }, baseUrl: "https://tonejs.github.io/audio/gong/", defaultNotation: "C2, 1m, 0", instrumentName: "Gong (Sampled)" },
            'Organ': { type: 'Sampler', samples: { 'C3': 'C3.mp3', 'E3': 'E3.mp3', 'G3': 'G3.mp3' }, baseUrl: 'https://tonejs.github.io/audio/salamander/', defaultNotation: "C3, 4n, 0; E3, 4n, +4n; G3, 4n, +4n; C4, 4n, +4n", instrumentName: "Organ (Sampled)" },
            'Synth': { type: 'Synth', defaultNotation: "C4, 4n, 0; E4, 4n, +4n; G4, 4n, +4n; C5, 4n, +4n", instrumentName: "Synth (Experimental)" },
            'Violin': { type: 'PolySynth', defaultNotation: "C4, 4n, 0; E4, 4n, +4n; G4, 4n, +4n; C5, 4n, +4n", instrumentName: "Violin (Experimental)" },
            'Cello': { type: 'PolySynth', defaultNotation: "C3, 4n, 0; E3, 4n, +4n; G3, 4n, +4n; C4, 4n, +4n", instrumentName: "Cello (Experimental)" },
            'Flute': { type: 'FMSynth', defaultNotation: "C5, 4n, 0; E5, 4n, +4n; G5, 4n, +4n; C6, 4n, +4n", instrumentName: "Flute (Experimental)" },
        };

        /**
         * Increments the loading counter and updates the UI.
         * Only called for the initial preload Sampler instances.
         */
        function incrementSamplerLoad() {
            samplerLoadedCount++;
            // Ensure the percentage never exceeds 100%
            const percent = Math.min(100, Math.floor((samplerLoadedCount / totalSamplers) * 100));
            document.getElementById('start-text').textContent = `Loading Instruments... ${percent}%`;

            if (samplerLoadedCount >= totalSamplers && !initialized) {
                initialized = true;
                document.getElementById('loader-icon').classList.add('hidden');
                document.getElementById('start-btn').disabled = false;
                document.getElementById('start-text').textContent = 'Play';
                document.getElementById('stop-btn').disabled = false;
                Tone.Transport.bpm.value = 120; // Set default tempo
                
                // Add default tracks AFTER initialization is complete
                addTrack('Piano');
                addTrack('Drums');
            }
        }

        /**
         * Creates a temporary Sampler instance purely for preloading the audio files.
         * The instance is disposed immediately after loading to free memory.
         * This prevents the recursive calling of the load counter.
         */
        function createPreloadSampler(instrumentType) {
             const settings = instrumentSettings[instrumentType];
             if (!settings) return; // Should not happen

             new Tone.Sampler({
                urls: settings.samples,
                baseUrl: settings.baseUrl,
                onload: function() {
                    this.dispose(); // Dispose of the preloader instance
                    incrementSamplerLoad();
                },
                onerror: (error) => {
                    console.error(`Error loading ${instrumentType} sample:`, error);
                    this.dispose(); // Dispose even on error
                    incrementSamplerLoad(); // Count the attempt to load as completed
                }
            }).toDestination();
            // Note: We don't return this instance, as it's just for loading.
        }


        /**
         * Creates a NEW instrument instance for playback (called by addTrack).
         */
        function createInstrument(instrumentType) {
            switch (instrumentType) {
                case 'Piano':
                case 'Drums':
                case 'Gong':
                case 'Organ':
                    const settings = instrumentSettings[instrumentType];
                    // Samplers are created without an onload/onerror handler here, 
                    // as the assets are expected to be preloaded.
                    const sampler = new Tone.Sampler({
                        urls: settings.samples,
                        baseUrl: settings.baseUrl
                    }).toDestination();
                    return sampler;
                case 'Synth':
                    return new Tone.Synth({
                        oscillator: { type: "sine" },
                        envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
                    }).toDestination();
                case 'Violin':
                case 'Cello':
                    return new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: "triangle" },
                        envelope: { attack: 0.01, decay: 0.4, sustain: 0.1, release: 0.5 }
                    }).toDestination();
                case 'Flute':
                    return new Tone.FMSynth({
                        harmonicity: 3.0,
                        modulationIndex: 10,
                        oscillator: { type: 'sine' },
                        envelope: { attack: 0.01, decay: 0.3, sustain: 0.4, release: 0.8 }
                    }).toDestination();
                default:
                    console.error("Unknown instrument type:", instrumentType);
                    return new Tone.Synth().toDestination();
            }
        }

        window.addTrack = (instrumentType, initialNotation = null, initialVolume = 0) => {
            const settings = instrumentSettings[instrumentType];
            if (!settings) return;

            const instrument = createInstrument(instrumentType);
            const trackId = Date.now();
            const notation = initialNotation !== null ? initialNotation : settings.defaultNotation;
            const volume = initialVolume;

            instrument.volume.value = parseFloat(volume);

            const trackPart = new Tone.Part((time, note) => {
                if (instrumentType === 'Drums' || instrumentType === 'Gong') {
                    instrument.triggerAttackRelease(note.note, note.duration, time);
                } else {
                    instrument.triggerAttackRelease(note.note, note.duration, time);
                }
            }, parseNotation(notation)).start(0);

            const newTrack = {
                id: trackId,
                instrument: instrument,
                part: trackPart,
                instrumentType: instrumentType,
                instrumentName: settings.instrumentName,
            };

            window.tracks.push(newTrack);
            renderTrackCard(newTrack, notation, volume);
            updateTransportLoop();
        };

        window.removeTrack = (trackId, shouldConfirm = true) => {
            if (shouldConfirm && !confirm("Are you sure you want to delete this track?")) {
                return;
            }

            const index = window.tracks.findIndex(t => t.id === trackId);
            if (index > -1) {
                const track = window.tracks[index];
                track.part.dispose();
                track.instrument.dispose();
                window.tracks.splice(index, 1);
                document.getElementById(`track-card-${trackId}`).remove();
                updateTransportLoop();
            }
        };

        function renderTrackCard(track, notation, volume) {
            const container = document.getElementById('tracks-container');
            const isExperimental = track.instrumentName.includes('(Experimental)');
            
            const cardHtml = `
                <div id="track-card-${track.id}" class="card p-4 rounded-xl flex flex-col">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xl font-semibold flex items-center">
                            ${track.instrumentType}
                            ${isExperimental ? `<span class="experimental-tag">Experimental</span>` : ''}
                        </h3>
                        <button onclick="removeTrack(${track.id})" 
                                class="btn-danger p-2 rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                            &times;
                        </button>
                    </div>
                    
                    <label class="text-sm font-medium mb-1 text-gray-400">Volume</label>
                    <input type="range" id="volume-${track.id}" min="-30" max="0" value="${volume}" 
                           oninput="updateVolume(${track.id}, this.value)"
                           class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                           <span class="text-xs text-gray-500 mb-3">${volume} dB</span>
                    
                    <label for="notation-${track.id}" class="text-sm font-medium mb-1 text-gray-400">Notation (Note, Duration, Time)</label>
                    <textarea id="notation-${track.id}" 
                              oninput="updatePart(${track.id}, this.value)"
                              class="notation-area input-style p-2 rounded-lg text-xs" 
                              placeholder="e.g., C4, 8n, 0; E4, 8n, +4n">${notation}</textarea>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', cardHtml);
        }

        // Parse notation from textarea into an array of Tone.js events
        function parseNotation(text) {
            const notes = [];
            const lines = text.split(';');
            lines.forEach(line => {
                const parts = line.trim().split(',').map(p => p.trim());
                if (parts.length >= 3) {
                    notes.push({ note: parts[0], duration: parts[1], time: parts[2] });
                }
            });
            return notes;
        }

        window.updateVolume = (trackId, value) => {
            const track = window.tracks.find(t => t.id === trackId);
            if (track) {
                track.instrument.volume.value = parseFloat(value);
            }
        };

        window.updatePart = (trackId, notationText) => {
            const track = window.tracks.find(t => t.id === trackId);
            if (track) {
                track.part.dispose(); 
                track.part = new Tone.Part((time, note) => {
                    if (track.instrumentType === 'Drums' || track.instrumentType === 'Gong') {
                         track.instrument.triggerAttackRelease(note.note, note.duration, time);
                    } else {
                        track.instrument.triggerAttackRelease(note.note, note.duration, time);
                    }
                }, parseNotation(notationText)).start(0);
                updateTransportLoop(); 
            }
        };

        function updateTransportLoop() {
            Tone.Transport.loopEnd = "1m"; 
            Tone.Transport.loop = true;
        }

        // ----------------------------------------------------------------------
        // 3. TRANSPORT CONTROLS
        // ----------------------------------------------------------------------

        window.startTransport = () => {
            if (Tone.Transport.state !== 'started') {
                Tone.Transport.start();
                document.getElementById('start-text').textContent = 'Pause';
                document.getElementById('start-btn').classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                document.getElementById('start-btn').classList.remove('btn-primary');
            } else {
                Tone.Transport.pause();
                document.getElementById('start-text').textContent = 'Play';
                document.getElementById('start-btn').classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                document.getElementById('start-btn').classList.add('btn-primary');
            }
        };

        window.stopTransport = () => {
            Tone.Transport.stop();
            document.getElementById('start-text').textContent = 'Play';
            document.getElementById('start-btn').classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            document.getElementById('start-btn').classList.add('btn-primary');
        };

        // ----------------------------------------------------------------------
        // 4. INITIALIZATION
        // ----------------------------------------------------------------------

        window.onload = () => {
            // Trigger preloading for the 4 Samplers. 
            // The createPreloadSampler function handles the counting and final initialization.
            ['Piano', 'Drums', 'Gong', 'Organ'].forEach(type => {
                createPreloadSampler(type);
            });
        };
    </script>
</body>
</html>
